#!/data/data/com.termux/files/usr/bin/env python3
import sys
from pathlib import Path

try:
    from PIL import Image
except ImportError:
    sys.exit('PIL (Pillow) is not installed.')

SUPPORTED_FORMATS = {'.png', '.bmp', '.gif', '.tiff', '.webp', '.ico', '.jpg', '.jpeg'}


def convert_to_jpg(file_path: str) -> bool:
    """Convert an image to JPG, handling transparency, and delete the original."""
    file_path = Path(file_path)

    if not file_path.is_file() or file_path.suffix.lower() not in SUPPORTED_FORMATS:
        return False

    # If already JPG, nothing to do
    if file_path.suffix.lower() in {'.jpg', '.jpeg'}:
        return True

    output_path = file_path.with_suffix('.jpg')

    # Ask before overwriting
    if output_path.exists():
        response = input(f"'{output_path.name}' exists. Overwrite? (y/n): ").strip().lower()
        if response != 'y':
            return False

    try:
        with Image.open(file_path) as img:
            # Handle transparency
            if img.mode in ('RGBA', 'LA', 'P'):
                rgb = Image.new('RGB', img.size, (255, 255, 255))
                alpha = img.convert('RGBA').split()[-1]  # get alpha channel
                rgb.paste(img, mask=alpha)
                rgb.save(output_path, 'JPEG', quality=95)
            else:
                img.convert('RGB').save(output_path, 'JPEG', quality=95)

        # Delete original file
        file_path.unlink()
        return True

    except Exception as e:
        print(f"Error converting '{file_path}': {e}")
        return False


def main():
    if len(sys.argv) != 2:
        print(f'Usage: {sys.argv[0]} <image_file>')
        sys.exit(1)

    if convert_to_jpg(sys.argv[1]):
        sys.exit(0)
    else:
        sys.exit(1)


if __name__ == '__main__':
    main()
