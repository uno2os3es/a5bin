#!/usr/bin/env python3

from __future__ import annotations

import argparse
import hashlib
import json
import subprocess
from concurrent.futures import ThreadPoolExecutor, as_completed
from pathlib import Path
from typing import Iterable

from tqdm import tqdm

IGNORED_DIRS = {'.git'}
CACHE_FILE = Path('.opng.cache')

# ---------- UTIL ----------


def run(cmd: list[str]) -> None:
    subprocess.run(cmd, check=True, stdout=subprocess.DEVNULL, stderr=subprocess.PIPE)


def sha256(path: Path) -> str:
    h = hashlib.sha256()
    with path.open('rb') as f:
        for chunk in iter(lambda: f.read(8192), b''):
            h.update(chunk)
    return h.hexdigest()


# ---------- PYTHON FILE DETECTION ----------


def is_png_file(path: Path) -> bool:
    if path.suffix == '.png':
        return True


def optimize_file(file: Path):
    run(['optipng', '-v', '-o7', file])


def load_cache() -> dict[str, str]:
    if CACHE_FILE.exists():
        try:
            return json.loads(CACHE_FILE.read_text())
        except Exception:
            return {}
    return {}


def save_cache(cache: dict[str, str]) -> None:
    CACHE_FILE.write_text(json.dumps(cache, indent=2))


# ---------- FILE COLLECTION ----------


def collect_files(paths: list[str]) -> list[Path]:
    if paths:
        return [p for p in map(Path, paths) if p.is_file() and is_png_file(p)]

    files: list[Path] = []
    for path in Path('.').rglob('*'):
        if not path.is_file():
            continue
        if any(part in IGNORED_DIRS for part in path.parts):
            continue
        if not is_png_file(path):
            continue
        files.append(path)
    return files


# ---------- EXECUTION ----------


def process_files(files: Iterable[Path], args) -> list[tuple[Path, str]]:
    errors: list[tuple[Path, str]] = []
    cache = load_cache()
    updated_cache = cache.copy()

    def task(file: Path) -> None:
        current_hash = sha256(file)
        cached_hash = cache.get(str(file))

        if cached_hash == current_hash:
            return

        optimize_file(file)

        updated_cache[str(file)] = sha256(file)

    with ThreadPoolExecutor() as executor:
        futures = {executor.submit(task, f): f for f in files}

        for future in tqdm(
            as_completed(futures),
            total=len(futures),
            desc='Formatting',
            unit='file',
        ):
            file = futures[future]
            try:
                future.result()
            except Exception as e:
                errors.append((file, str(e)))

    save_cache(updated_cache)
    return errors


def parse_args() -> argparse.Namespace:
    p = argparse.ArgumentParser(description='Fast png optimizer (in-place)')
    p.add_argument('files', nargs='*', help='Files to optimize (optional)')
    return p.parse_args()


def main() -> None:
    args = parse_args()
    files = collect_files(args.files)

    if not files:
        print('No png files detected.')
        return

    errors = process_files(files, args)

    if errors:
        print('\nErrors:')
        for file, err in errors:
            print(f'- {file}: {err}')
    else:
        print('\nDone. No errors.')


if __name__ == '__main__':
    main()
