#!/usr/bin/env python3
"""
Repack Python packages using pip wheel
Supports repacking individual packages or all packages in site-packages
"""

import argparse
import subprocess
import sys
from pathlib import Path
import site

def get_site_packages():
    """Get the site-packages directory path"""
    site_packages = site.getsitepackages()
    if site_packages:
        return Path(site_packages[0])
    return Path(site.__file__).parent / 'site-packages'

def get_installed_packages():
    """Get list of installed packages"""
    try:
        result = subprocess.run(
            ['pip', 'list', '--format=freeze'],
            capture_output=True,
            text=True,
            check=True
        )
        packages = []
        for line in result.stdout.strip().split('\n'):
            if '==' in line:
                pkg_name = line.split('==')[0]
                packages.append(pkg_name)
        return packages
    except subprocess.CalledProcessError as e:
        print(f"Error getting package list: {e}", file=sys.stderr)
        return []

def repack_package(package_name, output_dir, verbose=False):
    """Repack a single package using pip wheel"""
    if verbose:
        print(f"\n{'='*60}")
        print(f"Repacking package: {package_name}")
        print(f"{'='*60}")
    
    try:
        # Build wheel with --no-compile to skip .pyc files
        cmd = [
            'pip', 'wheel',
            '--no-deps',  # Don't download dependencies
            '--no-compile',  # Skip .pyc file generation
            '--wheel-dir', str(output_dir),
            package_name
        ]
        
        if verbose:
            print(f"Running command: {' '.join(cmd)}")
        
        result = subprocess.run(
            cmd,
            capture_output=True,
            text=True,
            check=True
        )
        
        if verbose:
            if result.stdout:
                print(f"STDOUT:\n{result.stdout}")
            if result.stderr:
                print(f"STDERR:\n{result.stderr}")
        
        print(f"✓ Successfully repacked: {package_name}")
        return True
        
    except subprocess.CalledProcessError as e:
        print(f"✗ Error repacking {package_name}: {e}", file=sys.stderr)
        if verbose:
            if e.stdout:
                print(f"STDOUT:\n{e.stdout}", file=sys.stderr)
            if e.stderr:
                print(f"STDERR:\n{e.stderr}", file=sys.stderr)
        return False
    except Exception as e:
        print(f"✗ Unexpected error repacking {package_name}: {e}", file=sys.stderr)
        return False

def main():
    parser = argparse.ArgumentParser(
        description='Repack Python packages using pip wheel',
        formatter_class=argparse.RawDescriptionHelpFormatter
    )
    
    parser.add_argument(
        'packages',
        nargs='*',
        help='Package names to repack (if not using --all)'
    )
    
    parser.add_argument(
        '-a', '--all',
        action='store_true',
        help='Repack all installed packages'
    )
    
    parser.add_argument(
        '-o', '--output-dir',
        type=Path,
        default=Path.home() / 'tmp' / 'whl',
        help='Output directory for .whl files (default: ~/tmp/whl)'
    )
    
    parser.add_argument(
        '-v', '--verbose',
        action='store_true',
        help='Enable verbose output'
    )
    
    args = parser.parse_args()
    
    # Validate arguments
    if not args.all and not args.packages:
        parser.error("Either specify package names or use --all flag")
    
    # Create output directory
    args.output_dir.mkdir(parents=True, exist_ok=True)
    
    if args.verbose:
        print(f"Output directory: {args.output_dir}")
        print(f"Site-packages: {get_site_packages()}")
    
    # Get packages to repack
    if args.all:
        packages = get_installed_packages()
        if args.verbose:
            print(f"\nFound {len(packages)} installed packages")
    else:
        packages = args.packages
    
    if not packages:
        print("No packages to repack", file=sys.stderr)
        return 1
    
    # Repack packages
    success_count = 0
    failed_packages = []
    
    print(f"\nRepacking {len(packages)} package(s)...\n")
    
    for package in packages:
        if repack_package(package, args.output_dir, args.verbose):
            success_count += 1
        else:
            failed_packages.append(package)
    
    # Summary
    print(f"\n{'='*60}")
    print(f"Summary:")
    print(f"  Total packages: {len(packages)}")
    print(f"  Successfully repacked: {success_count}")
    print(f"  Failed: {len(failed_packages)}")
    
    if failed_packages:
        print(f"\nFailed packages:")
        for pkg in failed_packages:
            print(f"  - {pkg}")
    
    print(f"\nWheel files saved to: {args.output_dir}")
    print(f"{'='*60}")
    
    return 0 if not failed_packages else 1

if __name__ == '__main__':
    sys.exit(main())
